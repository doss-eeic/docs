# VS Code で C/C++ プロジェクトをデバッグする

## 事前準備

VS Code 左端のバー（アクティビティバー）から四角が 4 つ並んだ拡張機能のボタンを選び、検索バーに「C++」と入力する。そこで出てくる「C/C++ Extension Pack」をインストール。

## デバッグ設定

macOS で gdb を使用するのはかなり面倒なので、lldb の利用を推奨。基本的なコマンド体系は gdb と同じなので安心して良い。

1. ソースコードがあるフォルダを VS Code で開く。
2. VS Code のアクティビティバーから「実行とデバッグ」を選択し、「launch.json ファイルを作成します」をクリック。「C/C++ (GDB/LLDB)」「LLDB」などと書かれたものがあれば選択（何も聞かれずにいきなり `launch.json` が作られる場合もある）。
3. `.vscode/launch.json` というファイルができているので、これを例えば以下のように編集する。

    ```jsonc
    {
      "version": "0.2.0",
      "configurations": [
        {
          "name": "C/C++: debug",
          "type": "cppdbg",
          "request": "launch",
          "program": "ビルドしたバイナリへの絶対パス",
          "args": ["a.gnuplot"],          // 実行時引数
          "stopAtEntry": true,            // 実行後すぐに一旦止める
          "cwd": "${workspaceFolder}",    // 実行時の作業ディレクトリ
          "MIMode": "gdb"                 // 利用するデバッガ。macOS の場合は lldb 推奨
        }
      ]
    }
    ```

## デバッグ

1. アクティビティバーの「実行とデバッグ」を選択し、実行ボタン（三角）を押す
2. エディタがデバッグモードに切り替わり、上部に以下のような操作バーが出てくる。左から
    - 続行（gdb での `c`）
    - ステップオーバー（gdb での `n`）
    - ステップイン（gdb での `s`）
    - ステップアウト（gdb での `fin`）
    - 再起動（gdb での `r`）
    - 停止（gdb での `exit`）

    である。

    ![debug-bar.png](images/debug-bar.png)

### 変数の表示

エディタ上で変数にマウスをホバーさせれば変数の中身が表示される。また、サイドバーの「ウォッチ式」に `&(gp_input_line[start])` などと入力すればその値が表示できる。

ポインタを配列として表示したい場合はウォッチ式を使う。入力すべき式は利用しているデバッガによって異なる。

例 : `int*` である `array` を長さ 10 の `int` の配列として表示したい場合

- gdb : `*array@10`
- lldb : `*(int(*)[10])array`

### ブレークポイントの設置

エディタ上で行番号の左側をクリックするとその行にブレークポイントが設置できる。ブレークポイントの一覧はサイドバーにある。

### 標準入力を扱う

上記の設定ではプログラム実行中に標準入力を渡すことができない。必要な場合には以下の行を `launch.json` に追加する。この設定をするとターミナルアプリが起動し、そちらから入力できるようになる。

```jsonc
{
  "version": "0.2.0",
  "configurations": [
    {
      ...,
      "externalConsole": true    // この行を追加
    }
  ]
}
```

## その他の機能

### 検索

いわゆる検索（grep）は以下の方法でできる。

- `Ctrl/Cmd + Shift + F` : ワークスペース全体で検索
- `Ctrl/Cmd + F` : 今開いているファイル内で検索

この場合コメント内のキーワード等も検索に引っかかるので、関数等を検索したい場合は次の方法を使う。

### シンボル検索

プログラム中に定義されているシンボル（変数、関数など）を検索したい場合は以下の方法でできる。

- `Ctrl/Cmd + T` : ワークスペース全体で検索
- `Ctrl/Cmd + Shift + T` : 今開いているファイル内で検索

### 定義元・参照先ジャンプ

「3.18 etags コマンド + find-tag で定義へ飛ぶ」に相当。エディタ内に表示されている変数や関数の定義元・参照先を知りたい場合は、単に右クリックして対応するメニューを選べば良い。
